Troubleshooting
===================

Indoor maps can be complex! On this page you'll find some common problems and fixes for them.

- Indoor Map Submissions
	- [Failed Schema Validation](#failed-schema-validation)
	- [Multipolygon Errors](#multipolygon-errors)
- Indoor Navigation Paths
	- [Failure to find indoor routes](#failure-to-find-indoor-routes)
- Indoor Assets
	- [Importing: Failed to find any matching inserts](#importing-failed-to-find-any-matching-inserts)


## Indoor Map Submissions

### Failed Schema Validation 

The submission service will email you if your map doesn't meet the [specification for our GeoJSON](FORMAT.md).

Common problems are:

1. Incorrect CRS. The CRS (Coordinate Reference System) must be WGS84 ([EPSG: 3857](http://spatialreference.org/ref/sr-org/6864/)).  This can be set at the time of export from QGIS.
2. Missing ids.  The ids for features can be generated by following the instructions in [the tutorial](TUTORIAL.md#user-content-generate-feature-ids).


### Multipolygon errors

If you are receiving an error related to multipolygons in your submission, it probably refers to one of your units being split into two or more parts - this is not supported by our Indoor Map format, and must be separated. For instance:


[<img src="/images/tutorial/multipolygon_appearance.png">](/images/tutorial/multipolygon_appearance.png) 

If you are struggling to locate the multipolygon in question, you can use QGIS' **Topology Checker** to find it:

1. Open the Topology Checker panel via *Vector > Topology Checker > Topology Checker*
	
	[<img src="/images/tutorial/topology_checker_location.png">](/images/tutorial/topology_checker_location.png)

2. Click the *Configure* button (Wrench icon)
3. Under *Current Rules* set the layer you want to check and set the rule to *"must not have multi-part geometries"*
4. Click *Add Rule* then click *OK*
	
	[<img src="/images/tutorial/topology_checker_steps.png">](/images/tutorial/topology_checker_steps.png)

5. Click *Validate All* (check mark) in the Topology Checker panel
6. The offending multipolygon will be displayed in the error list, and will be highlighted in red in QGIS
	
	[<img src="/images/tutorial/topology_checker_results.png">](/images/tutorial/topology_checker_results.png)


## Indoor Navigation Paths

### Failure to find indoor routes

To create a valid graph for routing, paths must connect to each other by sharing exactly the same point. It can be difficult to see if paths are intersecting correctly in QGIS.  If not, the routing service will fail to find a route connecting two points.

You can check the path definitions for a single floor in QGIS, using the v.net.components algorithm from the GRASS GIS plugin. 

1. Ensure the GRASS GIS plugin is installed.
2. In the Toolbox panel (View/Panels/Toolbox), open the v.net.components algorithm from the Vector collection under GRASS GIS.
3. Select the layer corresponding to the floor paths and click run.
4. The algorithm will add a "Network Components Line" layer in QGIS.  Right-click this and select "Properties".
5. Ensure the "Style" option is selected and change "Single symbol" to "Categorized" in the drop-down at the top.
6. Check the selected column is "comp" (or "123comp"), and click "Classify".

This will apply a different color to each unconnected part of the graph.  If the graph is fully connected, there will ony be one color and one legend entry under "Network Components Line".  If the graph is not fully connected, you can see where you need to add vertices in QGIS to connect components.


## Indoor Assets

### Importing: Failed to find any matching inserts

If you recieve an error or warning regarding failing to find valid instances or inserts, this is usually because a regex specified in your import config.json has failed to find any matching patterns within the supplied AutoCAD DXF file.  In some cases, such as using the same config across multiple DXF files that may or may not have certain inserts, this may be expected.  However, when specifying Instance Aligned rotation anchors or Name Label inserts, it will error if it fails to find at least one matching insert.

To fix this, double check the DXF and your specified regex patterns to ensure a match.
